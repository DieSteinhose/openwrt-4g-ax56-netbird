
name: build

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write

env:
  image: ramips-mt7621
  openwrt_version: SNAPSHOT
  profile: asus_4g-ax56
  # Base packages plus Netbird VPN dependencies (beginning with the second line)
  packages: >-
    luci htop nano picocom kmod-usb-net-cdc-ncm
    kmod-crypto-lib-chacha20 kmod-crypto-lib-poly1305 kmod-crypto-lib-chacha20poly1305
    kmod-crypto-kpp kmod-crypto-lib-curve25519 kmod-udptunnel4 kmod-udptunnel6
    kmod-wireguard kmod-tun
  netbird_version: ""

jobs:

  create-image:
  
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare image-files overlay dir
        run: |
          rm -rf image-files
          mkdir -p image-files/usr/bin

      - name: Copy overlay files from repo
        run: |
          test -d overlay
          cp -R overlay/. image-files/

      - name: Download and install ATC .apk into overlay
        run: |
          set -e
          mkdir -p atc-pkgs
          urls=(
            "https://github.com/mrhaav/openwrt/raw/master/atc/fib-fg621_ea/atc-fib-fg621_ea-2025.06.06-r2.apk"
            "https://github.com/mrhaav/openwrt/raw/master/atc/luci-proto-atc-2025.01.10-r2.apk"
            "https://github.com/mrhaav/openwrt/raw/master/atc/rssi_d/atc-rssi_d-2025.03.17-r1.apk"
          )
          for url in "${urls[@]}"; do
            out="atc-pkgs/$(basename "$url")"
            echo "Downloading $url"
            curl -fL -o "$out" "$url"
          done

          # Use Alpine's apk tool inside a container to install into the overlay rootfs (bake into image)
          docker run --rm \
            -v "$PWD/image-files:/rootfs" \
            -v "$PWD/atc-pkgs:/pkgs" \
            alpine:3 \
            sh -c "apk --root /rootfs --initdb add --allow-untrusted /pkgs/*.apk"

      - name: Download latest Netbird release (auto-detect mipsle asset)
        run: |
          # API URL for the latest release
          GITHUB_API="https://api.github.com/repos/netbirdio/netbird/releases/latest"

          echo "Querying latest Netbird release via public GitHub API..."
          NETBIRD_TAG=$(curl -sSL "$GITHUB_API" | jq -r '.tag_name // empty')

          if [ -z "$NETBIRD_TAG" ]; then
            echo "Could not determine Netbird tag" >&2
            exit 1
          fi

          NETBIRD_VERSION="${NETBIRD_TAG#v}"
          echo "netbird_version=$NETBIRD_TAG" >> "$GITHUB_ENV"

          ASSET_URL="https://github.com/netbirdio/netbird/releases/download/${NETBIRD_TAG}/netbird_${NETBIRD_VERSION}_linux_mipsle_softfloat.tar.gz"

          echo "Downloading Netbird ${NETBIRD_TAG} asset from $ASSET_URL"
          curl -L -o /tmp/netbird.tar.gz "$ASSET_URL"

      - name: Extract Netbird binary into overlay
        run: |
          # Locate the netbird binary inside the tarball and copy it into the overlay
          BIN=$(tar -tzf /tmp/netbird.tar.gz | grep -E '/?netbird$' | head -n1)
          if [ -z "$BIN" ]; then
            echo "Netbird binary not found in archive" >&2
            exit 1
          fi
          tar -xzf /tmp/netbird.tar.gz -C /tmp "$BIN"
          cp "/tmp/$BIN" image-files/usr/bin/netbird
          chmod +x image-files/usr/bin/netbird

      - name: Show overlay contents (debug)
        run: |
          echo "Overlay tree:"
          find image-files -maxdepth 4 -type f -ls

      - name: Build OpenWrt image (ImageBuilder Action)
        uses: herbetom/openwrt-gh-action-imagebuilder@v1
        with:
          release: ${{ env.openwrt_version }}
          target-name: ${{ env.image }}
          profile: ${{ env.profile }}
        env:
          PACKAGES: ${{ env.packages }}
          FILES_DIR: ${{ github.workspace }}/image-files
      
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.openwrt_version }}-${{ github.run_number }}
          body: |
            Custom OpenWrt build ...
            
            * OpenWrt version: ${{ env.openwrt_version }}
            * Netbird version: ${{ env.netbird_version }}
            * Image: ${{ env.image }}
            * Profile: ${{ env.profile }}
            * Packages: ${{ env.packages }}
            
          files: |
            bin/**/*  
