#!/bin/sh
set -e

# 99-install-atc: install bundled ATC packages from /root/atc
# If luci-proto-atc is already installed, skip.

if apk info -e luci-proto-atc >/dev/null 2>&1; then
    exit 0
fi

DIR=/root/atc
[ -d "$DIR" ] || exit 0

set --
for pkg in "$DIR"/*.apk; do
    [ -f "$pkg" ] || continue
    set -- "$@" "$pkg"
done

[ "$#" -gt 0 ] || exit 0

# Install all found package files in one apk invocation.
apk add --allow-untrusted --no-network "$@"

# Reboot is needed for the packages to become available, but we must not reboot
# *during* uci-defaults execution, otherwise the script won't get cleaned up and
# we'll end up in a reboot loop. Schedule a reboot shortly after this script exits.
sync
( sleep 5; reboot ) >/dev/null 2>&1 &

exit 0