#!/bin/sh /etc/rc.common

START=99
USE_PROCD=1

boot() {
    start
}

start_service() {
    logger -t atc-delayed-reboot "Service started, monitoring for 'Modem not ready yet'"
    procd_open_instance
    procd_set_param command /bin/sh -c '
        COUNT=0
        FIRST_TS=0
        logread -f | while read LINE; do
            if echo "$LINE" | grep -q "Modem not ready yet"; then
                NOW=$(date +%s)
                if [ "$COUNT" -eq 0 ]; then
                    FIRST_TS=$NOW
                    COUNT=1
                    logger -t atc-delayed-reboot "Modem not ready (1/3)"
                else
                    ELAPSED=$((NOW - FIRST_TS))
                    if [ "$ELAPSED" -le 90 ]; then
                        COUNT=$((COUNT + 1))
                        logger -t atc-delayed-reboot "Modem not ready ($COUNT/3) within 90s window"
                        if [ "$COUNT" -ge 3 ]; then
                            logger -t atc-delayed-reboot "Modem not ready 3 times in 90s, rebooting"
                            sync
                            reboot
                            exit 0
                        fi
                    else
                        FIRST_TS=$NOW
                        COUNT=1
                        logger -t atc-delayed-reboot "Modem not ready (1/3) - reset window"
                    fi
                fi
            fi
        done
    '
    procd_set_param respawn 3600 5 0
    procd_close_instance
}
